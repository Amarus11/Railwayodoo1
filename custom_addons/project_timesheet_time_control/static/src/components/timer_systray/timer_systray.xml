<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="project_timesheet_time_control.TimesheetTimerSystray">
        <div class="o_timer_systray_container">
            <!-- Systray icon button -->
            <div class="o_timer_systray_icon" t-on-click="togglePanel"
                 t-att-class="state.isRunning ? 'o_timer_systray_running' : ''"
                 t-att-title="state.isRunning ? state.elapsedText : 'Start Timer'">
                <i t-att-class="state.isRunning ? 'fa fa-stop-circle' : 'fa fa-play-circle'"/>
                <span t-if="state.isRunning" class="o_timer_systray_time"
                      t-esc="state.elapsedText"/>
            </div>

            <!-- Expandable panel -->
            <div t-if="state.panelOpen" class="o_timer_systray_panel">
                <div class="o_systray_panel_header">
                    <strong><i class="fa fa-clock-o me-1"/> Timer</strong>
                    <button class="o_systray_panel_close" t-on-click="togglePanel">
                        <i class="fa fa-times"/>
                    </button>
                </div>

                <!-- Description -->
                <div class="o_systray_field">
                    <input type="text"
                           class="o_systray_input"
                           t-att-value="state.description"
                           t-on-input="onDescriptionInput"
                           placeholder="What are you working on?"/>
                </div>

                <!-- Project selector -->
                <div class="o_systray_field o_systray_selector">
                    <button class="o_systray_selector_btn" t-on-click="toggleProjectDropdown">
                        <i class="fa fa-folder-o me-1"/>
                        <span t-esc="state.projectName || 'Select Project'"/>
                        <i class="fa fa-caret-down ms-auto"/>
                    </button>
                    <div t-if="state.showProjectDropdown" class="o_systray_dropdown">
                        <input type="text" placeholder="Search projects..."
                               t-att-value="state.projectSearch"
                               t-on-input="onProjectSearchInput"
                               class="o_systray_dropdown_search"/>
                        <div class="o_systray_dropdown_list">
                            <t t-foreach="filteredProjects" t-as="project" t-key="project.id">
                                <div class="o_systray_dropdown_item"
                                     t-att-class="state.projectId === project.id ? 'active' : ''"
                                     t-on-click="() => this.selectProject(project)">
                                    <i class="fa fa-folder-o me-2 text-muted"/>
                                    <span t-esc="project.name"/>
                                </div>
                            </t>
                            <div t-if="!filteredProjects.length" class="o_systray_dropdown_empty">
                                No projects found
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task selector -->
                <div class="o_systray_field o_systray_selector">
                    <button class="o_systray_selector_btn" t-on-click="toggleTaskDropdown"
                            t-att-disabled="!state.projectId">
                        <i class="fa fa-tasks me-1"/>
                        <span t-esc="state.taskName || 'Select Task'"/>
                        <i class="fa fa-caret-down ms-auto"/>
                    </button>
                    <div t-if="state.showTaskDropdown" class="o_systray_dropdown">
                        <input type="text" placeholder="Search tasks..."
                               t-att-value="state.taskSearch"
                               t-on-input="onTaskSearchInput"
                               class="o_systray_dropdown_search"/>
                        <div class="o_systray_dropdown_list">
                            <t t-foreach="filteredTasks" t-as="task" t-key="task.id">
                                <div class="o_systray_dropdown_item"
                                     t-att-class="state.taskId === task.id ? 'active' : ''"
                                     t-on-click="() => this.selectTask(task)">
                                    <i class="fa fa-check-square-o me-2 text-muted"/>
                                    <span t-esc="task.name"/>
                                </div>
                            </t>
                            <div t-if="!filteredTasks.length" class="o_systray_dropdown_empty">
                                No tasks found
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tags selector -->
                <div class="o_systray_field o_systray_selector">
                    <button class="o_systray_selector_btn" t-on-click="toggleTagDropdown">
                        <i class="fa fa-tags me-1"/>
                        <t t-if="state.tagNames.length">
                            <t t-foreach="state.tagNames" t-as="tname" t-key="tname_index">
                                <span class="o_systray_tag_badge"
                                      t-att-style="'background-color:' + getTagColor(tname_index)">
                                    <t t-esc="tname"/>
                                </span>
                            </t>
                        </t>
                        <span t-else="">Tags</span>
                        <i class="fa fa-caret-down ms-auto"/>
                    </button>
                    <div t-if="state.showTagDropdown" class="o_systray_dropdown">
                        <input type="text" placeholder="Search tags..."
                               t-att-value="state.tagSearch"
                               t-on-input="onTagSearchInput"
                               class="o_systray_dropdown_search"/>
                        <div class="o_systray_dropdown_list">
                            <t t-foreach="filteredTags" t-as="tag" t-key="tag.id">
                                <div class="o_systray_dropdown_item"
                                     t-on-click="() => this.toggleTag(tag)">
                                    <span class="o_systray_tag_dot"
                                          t-att-style="'background-color:' + getTagColor(tag.color)"/>
                                    <span t-esc="tag.name" class="flex-grow-1"/>
                                    <i t-if="isTagSelected(tag.id)" class="fa fa-check text-success"/>
                                </div>
                            </t>
                            <div t-if="!filteredTags.length" class="o_systray_dropdown_empty">
                                No tags found
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Start / Stop button -->
                <div class="o_systray_field o_systray_actions">
                    <button class="o_systray_timer_btn"
                            t-att-class="state.isRunning ? 'o_systray_stop' : 'o_systray_start'"
                            t-on-click="onToggleTimer">
                        <i t-att-class="state.isRunning ? 'fa fa-stop me-1' : 'fa fa-play me-1'"/>
                        <t t-if="state.isRunning">Stop</t>
                        <t t-else="">Start</t>
                    </button>
                    <div t-if="state.isRunning" class="o_systray_elapsed">
                        <t t-esc="state.elapsedText"/>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>
